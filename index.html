<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spotify PKCE Login + Show Playlists</title>
</head>
<body>
  <h1>Spotify Playlist Sorter</h1>
  <button id="login-btn">Log in with Spotify</button>
  <div id="content"></div>

  <script>
    const CLIENT_ID = 'ba37566cccad46cf8b1333dc9c8ef7e4'; // Replace with your Spotify client ID
    const REDIRECT_URI = 'https://stealerofpie.github.io/songs-starting-with/'; // Replace with your GitHub Pages URL
    const SCOPES = 'playlist-read-private';

    // Generate random string
    function generateRandomString(length) {
      const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let result = '';
      for (let i = 0; i < length; i++) {
        result += charset.charAt(Math.floor(Math.random() * charset.length));
      }
      return result;
    }

    // Create code challenge from code verifier
    async function generateCodeChallenge(codeVerifier) {
      const data = new TextEncoder().encode(codeVerifier);
      const digest = await crypto.subtle.digest('SHA-256', data);
      return btoa(String.fromCharCode(...new Uint8Array(digest)))
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=+$/, '');
    }

    // Show playlists in the #content div
    function showPlaylists(playlists) {
      const content = document.getElementById('content');
      if (playlists.length === 0) {
        content.textContent = 'No playlists found.';
        return;
      }
      const ul = document.createElement('ul');
      playlists.forEach(pl => {
        const li = document.createElement('li');
        li.textContent = pl.name;
        ul.appendChild(li);
      });
      content.innerHTML = '<h2>Your Playlists:</h2>';
      content.appendChild(ul);
    }

    // Fetch playlists using access token
    async function fetchPlaylists(token) {
      const response = await fetch('https://api.spotify.com/v1/me/playlists', {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await response.json();
      if (data.items) {
        showPlaylists(data.items);
      } else {
        document.getElementById('content').textContent = 'Failed to load playlists.';
        console.error(data);
      }
    }

    // Handle the redirect from Spotify after login
    async function handleRedirect() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');

      if (!code) {
        // No code = show login button
        document.getElementById('login-btn').style.display = 'inline-block';
        return;
      }

      document.getElementById('login-btn').style.display = 'none';

      const codeVerifier = localStorage.getItem('code_verifier');
      if (!codeVerifier) {
        document.getElementById('content').textContent = 'Code verifier not found. Please log in again.';
        return;
      }

      // Exchange code for token
      const body = new URLSearchParams({
        client_id: CLIENT_ID,
        grant_type: 'authorization_code',
        code,
        redirect_uri: REDIRECT_URI,
        code_verifier: codeVerifier,
      });

      const response = await fetch('https://accounts.spotify.com/api/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body
      });

      const data = await response.json();

      if (data.access_token) {
        localStorage.setItem('access_token', data.access_token);
        // Clear the URL so the code param is gone (optional)
        window.history.replaceState({}, document.title, REDIRECT_URI);
        // Fetch and show playlists
        fetchPlaylists(data.access_token);
      } else {
        document.getElementById('content').textContent = 'Failed to get access token.';
        console.error(data);
      }
    }

    document.getElementById('login-btn').addEventListener('click', async () => {
      const codeVerifier = generateRandomString(128);
      const codeChallenge = await generateCodeChallenge(codeVerifier);

      localStorage.setItem('code_verifier', codeVerifier);

      const args = new URLSearchParams({
        response_type: 'code',
        client_id: CLIENT_ID,
        scope: SCOPES,
        redirect_uri: REDIRECT_URI,
        code_challenge_method: 'S256',
        code_challenge: codeChallenge,
      });

      window.location = `https://accounts.spotify.com/authorize?${args.toString()}`;
    });

    // When page loads, try handling redirect or check token
    window.onload = () => {
      const token = localStorage.getItem('access_token');
      if (token) {
        document.getElementById('login-btn').style.display = 'none';
        fetchPlaylists(token);
      } else {
        handleRedirect();
      }
    };
  </script>
</body>
</html>
